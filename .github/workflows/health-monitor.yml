name: Health Monitor (Out-of-Band)

# Out-of-band watchdog that does NOT depend on the database.
# When Postgres is down, pg_cron and the DB trigger can't fire.
# This workflow calls the monitor-health edge function externally
# and falls back to Resend API directly if it's unreachable.
#
# Required GitHub Secrets:
#   MONITOR_HEALTH_URL  — e.g. https://<project>.supabase.co/functions/v1/monitor-health
#   RESEND_API_KEY      — same key used by edge functions
#   ALERT_EMAIL_RECIPIENT — e.g. founder@fieldtek.ai

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch: {}

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Call monitor-health endpoint
        id: health
        continue-on-error: true
        run: |
          HTTP_STATUS=$(curl -s -o /tmp/health-response.json -w "%{http_code}" \
            --max-time 30 \
            --retry 2 \
            --retry-delay 5 \
            "${{ secrets.MONITOR_HEALTH_URL }}")

          echo "http_status=$HTTP_STATUS" >> "$GITHUB_OUTPUT"

          if [ "$HTTP_STATUS" -ge 200 ] 2>/dev/null && [ "$HTTP_STATUS" -lt 300 ] 2>/dev/null; then
            echo "result=healthy" >> "$GITHUB_OUTPUT"
            echo "Monitor returned HTTP $HTTP_STATUS — healthy"
          else
            echo "result=unhealthy" >> "$GITHUB_OUTPUT"
            echo "Monitor returned HTTP $HTTP_STATUS — unhealthy"
          fi

      - name: Send fallback alert via Resend
        if: steps.health.outputs.result != 'healthy'
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL_RECIPIENT: ${{ secrets.ALERT_EMAIL_RECIPIENT }}
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          HTTP_STATUS="${{ steps.health.outputs.http_status }}"

          curl -s -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer $RESEND_API_KEY" \
            -H "Content-Type: application/json" \
            -d @- <<PAYLOAD
          {
            "from": "FieldTek Alerts <info@fieldtek.ai>",
            "to": ["$ALERT_EMAIL_RECIPIENT"],
            "subject": "CRITICAL: Infrastructure health check failed (out-of-band)",
            "html": "<html><body style='font-family:-apple-system,sans-serif;padding:20px;'><div style='max-width:560px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08);'><div style='background:#ef4444;padding:20px 28px;'><h1 style='margin:0;font-size:18px;color:#fff;'>Infrastructure Alert</h1><p style='margin:6px 0 0;font-size:13px;color:rgba(255,255,255,.85);'>${TIMESTAMP}</p></div><div style='padding:28px;'><p style='margin:0 0 8px;font-size:13px;color:#888;text-transform:uppercase;'>Alert Type</p><p style='margin:0 0 20px;font-size:16px;font-weight:600;color:#333;'>Health Monitor Unreachable</p><p style='margin:0 0 8px;font-size:13px;color:#888;text-transform:uppercase;'>Details</p><p style='margin:0 0 20px;font-size:14px;color:#333;background:#f9fafb;padding:12px 16px;border-radius:8px;border-left:3px solid #ef4444;'>The monitor-health edge function returned HTTP ${HTTP_STATUS} or was unreachable. The database or Supabase platform may be down. This alert was sent directly via Resend, bypassing the database entirely.</p><p style='margin:0;font-size:13px;color:#888;'>Source: github-actions-watchdog</p><a href='https://fieldtek.ai/admin/system-health' style='display:inline-block;margin-top:16px;padding:10px 24px;background:#1e3a5f;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;font-weight:600;'>View Dashboard</a></div></div></body></html>"
          }
          PAYLOAD

          echo "Fallback alert email sent via Resend"
